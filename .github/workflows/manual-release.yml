name: Manual Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag to create release from (e.g., 1.26.3)'
        default: ''
        required: true
        type: string

env:
  CI: 1
  PRINT_GITHUB_ANNOTATIONS: 1

defaults:
  run:
    shell: bash

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out plugin repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: ./tldraw/.github/actions/setup
        with:
          working-directory: tldraw

      - name: Build types
        working-directory: tldraw
        run: yarn build-types

      - name: Build plugin
        working-directory: tldraw/apps/obsidian
        run: yarn build

      - name: Verify build outputs
        run: |
          cd tldraw/apps/obsidian/dist/production
          if [ ! -f "main.js" ] || [ ! -f "styles.css" ] || [ ! -f "manifest.json" ]; then
            echo "❌ Required build files not found"
            exit 1
          fi
          echo "✅ Build files verified"

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd tldraw/apps/obsidian/dist/production
          tag="${{ github.event.inputs.tag }}"
          
          # Check if release already exists
          if gh release view "$tag" &>/dev/null; then
            echo "Release $tag already exists, skipping"
            exit 0
          fi
          
          # Create draft release
          gh release create "$tag" \
            --title="$tag" \
            --notes="Manual release of tldraw-in-obsidian plugin version $tag" \
            --draft \
            main.js manifest.json styles.css
          
          echo "✅ Draft release created: $tag"